## **2.1 Example: Heat flux**
---
This example correspond to a 3D heat flux between 50 particles. The 50 particles are stack in a rectangular container. Two Dirichlet boundaries are place on top and the bottom of the container.


## 2.2 Features

- Solvers :`gls_navier_stokes_3d` and `dem_3d`
- Use `writing_initial_conditions`
- Heat flux problem
- Thermal conductivity coefficient for a granular flow
- Show how to generate an initial condition equation

## 2.3 Files used in this example

- Paramter file: `/example/heat_flux_simulation.prm` and `/example/insert_50_particles.prm`
- Python file : `/example/equation_generator.py`

## 2.4 Description of the case
 
 We simulate a granular flow that has 2 Dirichlet boundaries. The following schematic describes the geometry of the container and the temperature values for the boundaries. 

![](/images/problem_desctiprion.png)

## 2.5 Parameter file for insertion
 
## 2.5.1 Simulation and IO Control

There is no reason to extend the simulation because we just want the position of the particles in the container. 

```
subsection simulation control
  set time step        = 1e-6
  set time end         = 1
  set log frequency    = 100000
  set output frequency = 100000
  set output path      = ./vtu_file/
end
```
## 2.5.2 Model parameters
We want less amount of overlapping possible. 
```
subsection model parameters
  set contact detection method                = dynamic
  set dynamic contact search size coefficient = 0.9
  set neighborhood threshold                  = 1.3
  set particle particle contact force method  = hertz_mindlin_limit_force
  set particle wall contact force method      = nonlinear
  set integration method                      = velocity_verlet
end
```

## 2.5.3 Physical Properties
The physical properties are decided arbitrarily. 
```
subsection lagrangian physical properties
  set gx                       = 0.0
  set gy                       = 0.0
  set gz                       = -9.81
  set number of particle types = 1
  subsection particle type 0
    set size distribution type            = uniform
    set diameter                          = 0.02
    set number                            = 50
    set density particles                 = 1000
    set young modulus particles           = 100000000
    set poisson ratio particles           = 0.3
    set restitution coefficient particles = 0.90
    set friction coefficient particles    = 0.1
  end
  set young modulus wall           = 100000000
  set poisson ratio wall           = 0.3
  set restitution coefficient wall = 0.90
  set friction coefficient wall    = 0.3
end
```

## 2.5.4 insertion Info
We want 50 particles in our simulation. 
```
subsection insertion info
  set insertion method                               = non_uniform
  set inserted number of particles at each time step = 50
  set insertion frequency                            = 20000
  set insertion box minimum x                        = -0.030
  set insertion box minimum y                        = -0.030
  set insertion box minimum z                        = 0.01
  set insertion box maximum x                        = 0.030
  set insertion box maximum y                        = 0.030
  set insertion box maximum z                        = 0.5
  set insertion distance threshold                   = 1.4
  set insertion random number range                  = 0.75
  set insertion random number seed                   =321
end
```

## 2.5.5 Mesh
```
subsection mesh
  set type                                = dealii
  set grid type                           = subdivided_hyper_rectangle
  set grid arguments                      = 1, 1, 2 : -0.03, -0.031, 0.00 : 0.031, 0.031, 0.51 : false
  set initial refinement                  = 1
  set expand particle-wall contact search = true
end
```
## 2.6 Running the insertion
Launching the simulation is as simple as specifying the executable name and the parameter file. Assuming that the `dem_3d` executable is within your path, the simulation can be launched by typing:

    dem_3d insert_50_particles.prm


## 2.7 Generate initial condition equation

The particle insertion simulation output several VTU files in the same directory. Using the last VTU file generated by the simulation will generate the initial condition equation. First, we need to create a .py file to be able to write the equation. A file has already been created in the `example` folder, called `equation_generator.py`

```python
from initial_condition_functions import writing_initial_conditions
import os

vtu_filename = "out.50_particles.vtu" # the last vtu file generated by the previous simulation

writing_initial_conditions(vtu_filename,
    decimals=5,
    dimension='3D',
    directory_txt=os.path.abspath("."),
    directory_vtu=os.path.abspath(".")
    
     )

```

This will generate a txt file named `out.50_particles.txt`. This file will be use in the next simulation.

##  2.8 Parameter file for heat flux simulation 

This simulation will illustrate the heat flux for the two boundaries and will illustrate  the temperature distribution in the container for the particles and the fluid. 

## 2.8.1 Simulation and IO Control
The steady state come after a short time, so the simulation time do not need to be long. In our case, 5 sec is enough time to achieve the steady state.
```
subsection simulation control
  set method           = bdf1
  set time end         = 5
  set time step        = 1
  set adapt            = true
  set max cfl          = 0.5
  set output name      = out.
  set output frequency = 1
  set output path      = ./results_heat_flux/
end
```
## 2.8.2 multiphysics

The multiphysics need to be activated for the VOF, heat transfer, viscous dissipation and buoyancy force. 
```
subsection multiphysics
  set fluid dynamics          = false
  set VOF = true
  set heat transfer     = true
  set viscous dissipation     = true
  set buoyancy force          = true
end
```
## 2.8.2 VOF

The interface sharpening need to be enabled to reduce the smoothing. In our case, we do not want smoothing because it can merge multiple particles, generating links that are not real.

```
subsection VOF
  subsection interface sharpening
    set enable              = true
    set threshold           = 0.5
    set interface sharpness = 2
    set frequency           = 100000
  end
end
```
## 2.8.3 Initial condition
This is where the txt file will be used. We need to use the expression in the file for the Function expression. This will generate the initial of the particles for the VOF. 

We can set the temperature of the container at 250 K to reach the steady state faster. 

```
subsection initial conditions
  set type = nodal
  subsection uvwp
    set Function expression = 0; 0; 0 ; 0 
  end
  subsection VOF
    set Function expression = ((x--0.02)^2+(y--0.021)^2+(z-0.06954)^2<(0.01)^2?1:((x--0.02)^2+(y--0.021)^2+(z-0.04891)^2<(0.01)^2?1:((x--0.02)^2+(y--0.0207)^2+(z-0.01)^2<(0.01)^2?1:((x--0.01542)^2+(y--0.021)^2+(z-0.02945)^2<(0.01)^2?1:((x--0.00988)^2+(y--0.00474)^2+(z-0.09525)^2<(0.01)^2?1:((x--0.02)^2+(y--0.021)^2+(z-0.08953)^2<(0.01)^2?1:((x--0.02)^2+(y--0.00071)^2+(z-0.01)^2<(0.01)^2?1:((x--0.00659)^2+(y--0.01036)^2+(z-0.05924)^2<(0.01)^2?1:((x--0.00082)^2+(y--0.021)^2+(z-0.04326)^2<(0.01)^2?1:((x--0.0015)^2+(y--0.00133)^2+(z-0.07634)^2<(0.01)^2?1:((x-0.00104)^2+(y--0.00998)^2+(z-0.02668)^2<(0.01)^2?1:((x-0.02093)^2+(y--0.021)^2+(z-0.01)^2<(0.01)^2?1:((x-0.0193)^2+(y--0.01279)^2+(z-0.10081)^2<(0.01)^2?1:((x-0.021)^2+(y--0.01097)^2+(z-0.0273)^2<(0.01)^2?1:((x-0.01914)^2+(y--0.021)^2+(z-0.04449)^2<(0.01)^2?1:((x-0.02099)^2+(y--0.01518)^2+(z-0.06352)^2<(0.01)^2?1:((x-0.01982)^2+(y--0.00104)^2+(z-0.00999)^2<(0.01)^2?1:((x-0.00368)^2+(y--0.021)^2+(z-0.07268)^2<(0.01)^2?1:((x-0.0026)^2+(y--0.02015)^2+(z-0.09263)^2<(0.01)^2?1:((x-0.00053)^2+(y--0.021)^2+(z-0.01)^2<(0.01)^2?1:((x-0.021)^2+(y--0.021)^2+(z-0.08266)^2<(0.01)^2?1:((x-0.021)^2+(y--0.00139)^2+(z-0.078)^2<(0.01)^2?1:((x--0.01823)^2+(y-0.02085)^2+(z-0.0499)^2<(0.01)^2?1:((x--0.02)^2+(y-0.02002)^2+(z-0.01)^2<(0.01)^2?1:((x--0.01963)^2+(y-0.021)^2+(z-0.02996)^2<(0.01)^2?1:((x--0.02)^2+(y-0.01021)^2+(z-0.08667)^2<(0.01)^2?1:((x--0.00337)^2+(y-0.021)^2+(z-0.084)^2<(0.01)^2?1:((x--8e-05)^2+(y-0.00098)^2+(z-0.01)^2<(0.01)^2?1:((x--3e-05)^2+(y-0.021)^2+(z-0.00999)^2<(0.01)^2?1:((x--0.01862)^2+(y-0.021)^2+(z-0.06989)^2<(0.01)^2?1:((x--0.02)^2+(y-0.00043)^2+(z-0.04906)^2<(0.01)^2?1:((x--0.01583)^2+(y-0.00053)^2+(z-0.02951)^2<(0.01)^2?1:((x--0.02)^2+(y-0.00076)^2+(z-0.06905)^2<(0.01)^2?1:((x--0.02)^2+(y-0.021)^2+(z-0.1035)^2<(0.01)^2?1:((x--0.00392)^2+(y-0.00983)^2+(z-0.10758)^2<(0.01)^2?1:((x-0.02011)^2+(y-0.02098)^2+(z-0.01)^2<(0.01)^2?1:((x-0.021)^2+(y-0.021)^2+(z-0.0433)^2<(0.01)^2?1:((x-0.001)^2+(y-6e-05)^2+(z-0.04396)^2<(0.01)^2?1:((x-0.021)^2+(y-0.01957)^2+(z-0.06324)^2<(0.01)^2?1:((x-0.021)^2+(y-0.00993)^2+(z-0.02666)^2<(0.01)^2?1:((x-0.021)^2+(y-0.021)^2+(z-0.08318)^2<(0.01)^2?1:((x-0.00104)^2+(y-0.021)^2+(z-0.04457)^2<(0.01)^2?1:((x-0.00105)^2+(y-0.01101)^2+(z-0.02725)^2<(0.01)^2?1:((x-0.00859)^2+(y-0.0026)^2+(z-0.09315)^2<(0.01)^2?1:((x-0.01095)^2+(y-0.00241)^2+(z-0.06114)^2<(0.01)^2?1:((x-0.01111)^2+(y-0.021)^2+(z-0.10056)^2<(0.01)^2?1:((x-0.00105)^2+(y-0.01994)^2+(z-0.06453)^2<(0.01)^2?1:((x-0.021)^2+(y-0.00557)^2+(z-0.10855)^2<(0.01)^2?1:((x-0.00971)^2+(y-0.01731)^2+(z-0.12016)^2<(0.01)^2?1:((x-0.021)^2+(y-0.0)^2+(z-0.04402)^2<(0.01)^2?1:0))))))))))))))))))))))))))))))))))))))))))))))))))
  end
  subsection temperature
    set Function expression = 250
  end
end
```
## 2.8.4 Physical properties
The fluid 0 is the air in this case. We set all properties to 1 to have integer ratio. The fluid 1 is the particles. 

```
subsection physical properties
  set number of fluids = 2
  subsection fluid 0
    set density             = 1
    set kinematic viscosity = 1
    set specific heat         = 1
    set thermal conductivity = 1

  end
  subsection fluid 1
    set density             = 10
    set kinematic viscosity = 1
    set specific heat         = 500
    set thermal conductivity = 1000
  end
end
```
## 2.8.5 Boundry Conditions

The heat flux is created by the variation of temperature between the two boundaries on top and bottom of the container. The `bc0` is the bottom set to 200 K and `bc1` is the top set to 300 K
```
subsection boundary conditions heat transfer
set number                  = 2
    subsection bc 0
        set id              = 4
        set type            = temperature
        set value           = 200
    end
    subsection bc 1
        set id              = 5
        set type            = temperature
        set value           = 300
    end
end
```
## 2.8.6 Solver Control
```
subsection non-linear solver
  set tolerance      = 1e-4
  set max iterations = 25
  set verbosity      = verbose
end

subsection linear solver
  set verbosity                             = verbose
  set method                                = gmres
  set max iters                             = 10000
  set relative residual                     = 1e-4
  set minimum residual                      = 1e-5
  set ilu preconditioner fill               = 0
  set ilu preconditioner absolute tolerance = 1e-12
  set ilu preconditioner relative tolerance = 1.00
  set max krylov vectors                    = 200
end

```
## 2.9 Running the heat flux simulation 

Call the `gls_navier_stokes_3d` by invoking:

```
mpirun -np 5 gls_navier_stokes_3d heat_flux_simulation.prm
```

The simulation used 5 CPU cores. Feel free to use more.

⚠️ **Simulation time** : around 5 minutes on a i5-11600k processor. 

## 2.10 Results

The following figure shows the temperature distribution in the container for the previous simulation. 

![](/images/final_result_ratio_1000.png)

A python post-processing code was made to analyze the impact of the thermal conductivity ratio between the fluid and the particles. The following graphic exposes the linear reaction between the heat flux and the thermal conductivity ratio. The ratio is established `K_particule/K_fluide`

![](/images/heat_flux_ratio.png)